import React, { useState, useEffect } from 'react';

import {AiOutlineSearch} from 'react-icons/ai'
import {RiDashboardFill} from 'react-icons/ri'
import {IoIosArrowDroprightCircle,IoIosArrowDropleftCircle} from 'react-icons/io'
import {BiTargetLock} from 'react-icons/bi';
import {TiWarning} from 'react-icons/ti';
import {GoGraph} from 'react-icons/go';
import {MdDateRange} from 'react-icons/md';
import {FaUserFriends} from 'react-icons/fa';

import LinkNavigation from '../../components/LinkNavigation';

import api from '../../services/api';
import ContainerVulnerabilities from '../../components/ContainerVulnerabilities';

import './styles.css';
import BoxTitleIcons from '../../components/BoxTitleIcons';

export interface Vulnerabilities{

    id: number,
    title: string,
    severity: string,
    cvss: string,
    publication_date: string,
    asset_count: number
}


const ListVulnerabilities = () => {
    const [search,setSearch] = useState('')
    const [vulnerabilities, setVulnerabilities] = useState<Vulnerabilities[]>([]);
    const [filterSelect,setFilterSelect] = useState('');

   const [dataPaginate, setDataPaginate] = useState({
       previous: null,
       next: null,
       count: 0,
   })
   
   const [currentPage,setCurrentPage] = useState(1)

    useEffect(() => {
        api.get(`/api/vulnerabilities/?page=${currentPage}`).then(response => {
            const {count,previous,next} = response.data;
            setDataPaginate({count,previous,next})
            setVulnerabilities(response.data.results)
        });
        
    },[currentPage])


    function searchVulnerabilitiesByFilters(){
        api.get(`/api/vulnerabilities/?${filterSelect}=${search}`).then(response => {
            setVulnerabilities(response.data.results)
        })
    }

    function searchVulnerabilitiesByOrder(typeOrder: string){
        api.get(`api/vulnerabilities/?ordering=${typeOrder}`).then(response => {
            setVulnerabilities(response.data.results)
        })
    }

    function handleNextPage(){
        const next = currentPage + 1

        const totalPage = Math.ceil(dataPaginate.count / 50)

        if(currentPage < totalPage){
            setCurrentPage(next)
        }
    }

    function handlePrevPage(){
        const prev = currentPage - 1

        if(currentPage > 1){
            setCurrentPage(prev)
        }
    }

    return(
        <div className = 'container-list'>
             <header id = 'header-list'>
                <div className = 'header-content'>
                <div className = 'container-filter-order'>

                        <select name="filter" id="filter" onChange = {(e) => setFilterSelect(e.target.value)}>
                            <option value="">Filtrar por...</option>
                            <option value="asset">Host</option>
                            <option value="severity">Severidade</option>
                        </select>

                        <select name="order" 
                        onChange = {(e) => searchVulnerabilitiesByOrder(e.target.value)} 
                        id="order">

                            <option value="">Ordenar por...</option>
                            <option value="title">Título</option>
                            <option value="severity">Severidade</option>
                            <option value="cvss">CVSS</option>
                            <option value="asset_count">Hosts</option>
                        </select>
                    </div>

                    <div className = 'search-container'>
                        <div className = 'search'>
                            <AiOutlineSearch />
                            <input type="search" onChange = {(e) => setSearch(e.target.value)}/>
                            
                        </div>
                        <button type = 'button' onClick = {searchVulnerabilitiesByFilters}>Search</button>
                    </div>

            
                    <LinkNavigation urlLink = '/DashBoard' textLink = 'DashBoard' IconLink = {RiDashboardFill}/>
                </div>
               
            </header>

            <main id = 'main-list'>
            <div className = 'container-title-icons'>
                <BoxTitleIcons title = 'Título' size = 'calc(1vw + 0.6em)' color = '#6600ff' Icon = {BiTargetLock} />
                <BoxTitleIcons title = 'Severidade' size = 'calc(1vw + 0.6em)' color = '#ff6600' Icon = {TiWarning} />
                <BoxTitleIcons title = 'CVSS' size = 'calc(1vw + 0.6em)' color = '#00cc99' Icon = {GoGraph} />
                <BoxTitleIcons title = 'Data de publicação' size = 'calc(1vw + 0.6em)' color = '#0066ff' Icon = {MdDateRange} />
                <BoxTitleIcons title = 'Hosts afetados' size = 'calc(1vw + 0.6em)' color = '#cc3333' Icon = {FaUserFriends} />
            </div>
                <div className = 'box-list'>
                
                    {vulnerabilities.map(vulnerability => (
                         <ContainerVulnerabilities 
                         key = {vulnerability.id}
                         id = {vulnerability.id} 
                         title = {vulnerability.title} 
                         severity = {vulnerability.severity} 
                         cvss = {vulnerability.cvss}
                         publication_date = {vulnerability.publication_date}
                         asset_count = {vulnerability.asset_count}/>
                    ))}

                </div>
            </main>
            
            <footer id = 'footer-list'>
                <span>
                    Mostrando {vulnerabilities.length} de {dataPaginate.count} resultados
                </span>

                <div className = 'paginate-container'>
                     <button type = 'button' onClick = {handlePrevPage}>
                         <IoIosArrowDropleftCircle 
                         color = {dataPaginate.previous ? '#8c44f8' : 'rgb(188, 154, 204)'}  
                         size = 'calc(1vw + 1em)'/>
                     </button>

                     <strong>{currentPage}</strong>

                     <button type = 'button' onClick = {handleNextPage}>
                         <IoIosArrowDroprightCircle 
                         color = {dataPaginate.next ? '#8c44f8' : 'rgb(188, 154, 204)'} 
                         size = 'calc(1vw + 1em)' />
                     </button>
                </div>
            </footer>
           
        </div>
    )
}

export default ListVulnerabilities;
